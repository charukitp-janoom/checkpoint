<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>QR Generator ‚Äî Smart Checkpoint</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&family=Chakra+Petch:wght@400;600;700&display=swap" rel="stylesheet">
<!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ QRious ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<style>
:root{--bg:#07060f;--surface:#0e0d1c;--card:#141226;--border:#26234a;--border2:#3a375a;--accent:#7c6dfa;--accent2:#fa6d9e;--teal:#6dfae0;--success:#6dfaa0;--text:#e8e6ff;--mid:#a09cbf;--dim:#6b6890;--mono:'Chakra Petch',monospace;--sans:'Sarabun',sans-serif;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:24px 16px 60px;}
.wrap{width:100%;max-width:820px;}
.hdr{display:flex;align-items:center;gap:14px;padding:16px 0 24px;border-bottom:1px solid var(--border);margin-bottom:28px;}
.logo{width:44px;height:44px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;}
.hdr-title{font-family:var(--mono);font-size:16px;font-weight:700;color:var(--accent);letter-spacing:1px;}
.hdr-sub{font-size:12px;color:var(--dim);margin-top:2px;}
.layout{display:grid;grid-template-columns:1fr 340px;gap:20px;}
@media(max-width:700px){.layout{grid-template-columns:1fr;}}
.form-card,.preview-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:22px;}
.card-title{font-family:var(--mono);font-size:10px;letter-spacing:1.5px;color:var(--dim);margin-bottom:14px;}
.form-grp{display:flex;flex-direction:column;gap:5px;margin-bottom:12px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
label{font-family:var(--mono);font-size:9px;letter-spacing:1.2px;color:var(--dim);}
input{background:var(--surface);border:1px solid var(--border2);border-radius:7px;color:var(--text);font-family:var(--sans);font-size:13px;padding:8px 11px;outline:none;width:100%;transition:.2s;}
input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,109,250,.1);}
input[type=time]{font-family:var(--mono);color:var(--teal);}
input[type=url]{font-family:var(--mono);font-size:11px;color:var(--teal);}
input[type=number]{font-family:var(--mono);}
.divider{height:1px;background:var(--border);margin:14px 0;}
.btn-gen{width:100%;padding:13px;border-radius:9px;border:none;background:linear-gradient(135deg,var(--accent),#5a4de0);color:#fff;font-family:var(--sans);font-size:15px;font-weight:700;cursor:pointer;transition:.2s;box-shadow:0 4px 18px rgba(124,109,250,.3);}
.btn-gen:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(124,109,250,.4);}
.btn-row{display:flex;gap:8px;margin-top:10px;}
.btn-act{flex:1;padding:10px 6px;border-radius:8px;border:1px solid var(--border2);background:var(--surface);color:var(--mid);font-family:var(--sans);font-size:12px;cursor:pointer;transition:.15s;display:flex;align-items:center;justify-content:center;gap:5px;}
.btn-act:hover{border-color:var(--accent);color:var(--accent);}
.btn-act:disabled{opacity:.35;pointer-events:none;}
.preview-card{display:flex;flex-direction:column;align-items:center;gap:14px;}
.qr-stage{position:relative;padding:14px;background:#fff;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5);}
.qc{position:absolute;width:18px;height:18px;border-color:var(--accent);border-style:solid;}
.qc.tl{top:-2px;left:-2px;border-width:3px 0 0 3px;border-radius:3px 0 0 0;}
.qc.tr{top:-2px;right:-2px;border-width:3px 3px 0 0;border-radius:0 3px 0 0;}
.qc.bl{bottom:-2px;left:-2px;border-width:0 0 3px 3px;border-radius:0 0 0 3px;}
.qc.br{bottom:-2px;right:-2px;border-width:0 3px 3px 0;border-radius:0 0 3px 0;}
.qr-empty{width:220px;height:220px;background:var(--surface);border:2px dashed var(--border2);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:var(--dim);}
.qr-empty-icon{font-size:36px;opacity:.4;}
.qr-empty-txt{font-family:var(--mono);font-size:10px;letter-spacing:1px;text-align:center;}
.info-box{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:12px;}
.info-row{display:flex;justify-content:space-between;margin-bottom:6px;}
.info-row:last-child{margin-bottom:0;}
.info-k{font-family:var(--mono);font-size:9px;color:var(--dim);letter-spacing:1px;}
.info-v{font-family:var(--mono);font-size:11px;color:var(--teal);}
.status-bar{width:100%;display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:7px;font-family:var(--mono);font-size:10px;letter-spacing:1px;}
.status-bar.idle{background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--dim);}
.status-bar.loading{background:rgba(250,173,109,.07);border:1px solid rgba(250,173,109,.25);color:#faad6d;animation:pulse .8s infinite;}
.status-bar.ready{background:rgba(109,250,160,.07);border:1px solid rgba(109,250,160,.2);color:var(--success);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(12px);background:var(--card);border:1px solid var(--border2);padding:10px 20px;border-radius:9px;font-size:13px;opacity:0;transition:.3s;z-index:999;white-space:nowrap;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="logo">üî≤</div>
    <div>
      <div class="hdr-title">QR GENERATOR</div>
      <div class="hdr-sub">Smart Checkpoint System ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</div>
    </div>
  </div>
  <div class="layout">
    <!-- FORM -->
    <div class="form-card">
      <div class="card-title">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</div>
      <div class="form-grp"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à</label><input id="fName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏´‡∏ô‡πâ‡∏≤" oninput="onChange()"></div>
      <div class="form-row">
        <div class="form-grp"><label>CP-ID</label><input id="fId" placeholder="CP-01" style="font-family:var(--mono);" oninput="this.value=this.value.toUpperCase();onChange()"></div>
        <div class="form-grp"><label>‡∏£‡∏±‡∏®‡∏°‡∏µ (‡∏°.)</label><input id="fRadius" type="number" value="50" min="5" oninput="onChange()"></div>
      </div>
      <div class="form-row">
        <div class="form-grp"><label>Latitude</label><input id="fLat" placeholder="13.756300" style="font-family:var(--mono);color:var(--teal);" oninput="onChange()"></div>
        <div class="form-grp"><label>Longitude</label><input id="fLng" placeholder="100.501800" style="font-family:var(--mono);color:var(--teal);" oninput="onChange()"></div>
      </div>
      <div class="form-row">
        <div class="form-grp"><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input id="fFrom" type="time" value="08:00" oninput="onChange()"></div>
        <div class="form-grp"><label>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label><input id="fTo" type="time" value="20:00" oninput="onChange()"></div>
      </div>
      <div class="divider"></div>
      <div class="card-title">üîó LIFF URL</div>
      <div class="form-grp"><label>‡πÉ‡∏™‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ LIFF (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label><input id="fLiff" type="url" placeholder="https://liff.line.me/xxxxxxxxxx-xxxxxxxx" oninput="onChange()"></div>
      <button class="btn-gen" onclick="generate()">üî≤ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</button>
      <div class="btn-row">
        <button class="btn-act" id="btnDown" onclick="download()" disabled>‚¨á ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PNG</button>
        <button class="btn-act" id="btnPrint" onclick="doPrint()" disabled>üñ®Ô∏è Print</button>
        <button class="btn-act" id="btnCopy" onclick="copyUrl()" disabled>üîó URL</button>
      </div>
    </div>

    <!-- PREVIEW -->
    <div class="preview-card">
      <div class="card-title" style="width:100%;text-align:left;">üñºÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á QR</div>
      <div id="qrEmptyWrap"><div class="qr-empty"><div class="qr-empty-icon">üî≤</div><div class="qr-empty-txt">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br>‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡∏™‡∏£‡πâ‡∏≤‡∏á QR"</div></div></div>
      <div id="qrStageWrap" style="display:none;">
        <div class="qr-stage"><div class="qc tl"></div><div class="qc tr"></div><div class="qc bl"></div><div class="qc br"></div><canvas id="qrCanvas"></canvas></div>
      </div>
      <div class="status-bar idle" id="statusBar"><span id="statusTxt">‡∏£‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á QR</span></div>
      <div class="info-box" id="infoBox" style="display:none;">
        <div class="info-row"><span class="info-k">CP-ID</span><span class="info-v" id="iId">‚Äî</span></div>
        <div class="info-row"><span class="info-k">NAME</span><span class="info-v" id="iName">‚Äî</span></div>
        <div class="info-row"><span class="info-k">COORDS</span><span class="info-v" id="iCoord">‚Äî</span></div>
        <div class="info-row"><span class="info-k">RADIUS</span><span class="info-v" id="iRadius">‚Äî</span></div>
        <div class="info-row"><span class="info-k">TIME</span><span class="info-v" id="iTime">‚Äî</span></div>
        <div class="info-row"><span class="info-k">SIGNATURE</span><span class="info-v" style="color:var(--accent2)" id="iSig">‚Äî</span></div>
      </div>
    </div>
  </div>
</div>
<div id="toast"></div>
<script>
let currentUrl = null, currentPayload = null, qrReady = false;

function onChange() { 
  qrReady = false; 
  if (v('fLiff')) localStorage.setItem('sc_liff_url', v('fLiff'));
}

function validate() {
  const n=v('fName'),i=v('fId'),la=parseFloat(v('fLat')),lo=parseFloat(v('fLng'));
  if (!n) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∏‡∏î‡∏ï‡∏£‡∏ß‡∏à';
  if (!i) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å CP-ID';
  if (isNaN(la)||la===0) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Latitude';
  if (isNaN(lo)||lo===0) return '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Longitude';
  return null;
}

function v(id) { return document.getElementById(id).value.trim(); }

// ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™ Base64 ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (UTF-8)
function toBase64(str) {
  const bytes = new TextEncoder().encode(str);
  let binString = '';
  for (let i = 0; i < bytes.length; i++) {
    binString += String.fromCharCode(bytes[i]);
  }
  return btoa(binString);
}

function buildPayload() {
  const p = { v:1, cpId:v('fId'), name:v('fName'), lat:parseFloat(v('fLat')), lng:parseFloat(v('fLng')),
    radius:parseInt(v('fRadius'))||50, timeFrom:v('fFrom')||'00:00', timeTo:v('fTo')||'23:59', ts:Date.now() };
  p.sig = toBase64(JSON.stringify(p)).substr(0,16).toUpperCase();
  return p;
}

function buildUrl(payload) {
  const liff = v('fLiff');
  const enc = toBase64(JSON.stringify(payload));
  return liff ? `${liff}?cp=${enc}` : `data:checkpoint,${enc}`;
}

function generate() {
  const err = validate(); if (err) { toast('‚ùå '+err); return; }
  currentPayload = buildPayload();
  currentUrl = buildUrl(currentPayload);

  setStatus('loading','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á QR...');
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
  if (typeof QRious === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js';
    script.onload = () => drawQRCode();
    script.onerror = () => {
      setStatus('idle','‚ö†Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
      toast('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
    };
    document.head.appendChild(script);
  } else {
    drawQRCode();
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ
function drawQRCode() {
  const canvas = document.getElementById('qrCanvas');
  try {
    // ‡∏ß‡∏≤‡∏î QR Code
    new QRious({
      element: canvas,
      value: currentUrl,
      size: 220,
      level: 'H'
    });
    
    document.getElementById('qrEmptyWrap').style.display='none';
    document.getElementById('qrStageWrap').style.display='block';
    document.getElementById('infoBox').style.display='block';
    
    document.getElementById('iId').textContent    = currentPayload.cpId;
    document.getElementById('iName').textContent  = currentPayload.name;
    document.getElementById('iCoord').textContent = `${parseFloat(v('fLat')).toFixed(5)}, ${parseFloat(v('fLng')).toFixed(5)}`;
    document.getElementById('iRadius').textContent= currentPayload.radius + ' ‡∏°.';
    document.getElementById('iTime').textContent  = `${currentPayload.timeFrom} ‚Äì ${currentPayload.timeTo}`;
    document.getElementById('iSig').textContent   = currentPayload.sig;
    
    setStatus('ready','‚úÖ QR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚Äî ‡∏Å‡∏î ‚¨á ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PNG');
    qrReady = true;
    ['btnDown','btnPrint','btnCopy'].forEach(id => document.getElementById(id).disabled=false);
    toast('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
  } catch (error) {
    setStatus('idle','‚ö†Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
    document.getElementById('btnCopy').disabled=false;
    toast('‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÑ‡∏î‡πâ');
    console.error(error);
  }
}

function download() {
  if (!qrReady||!currentPayload) { toast('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏Å‡πà‡∏≠‡∏ô'); return; }
  const src = document.getElementById('qrCanvas');
  const c=document.createElement('canvas'); c.width=400; c.height=500;
  const ctx=c.getContext('2d');
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,400,500);
  ctx.fillStyle='#141226';
  rr(ctx,8,8,384,484,16); ctx.fill();
  const g=ctx.createLinearGradient(0,0,400,0); g.addColorStop(0,'#7c6dfa'); g.addColorStop(1,'#fa6d9e');
  ctx.fillStyle=g; rr(ctx,8,8,384,3,2); ctx.fill();
  ctx.fillStyle='#7c6dfa'; ctx.font='bold 13px monospace'; ctx.textAlign='center';
  ctx.fillText('üõ°Ô∏è SMART CHECKPOINT ¬∑ v2.5',200,40);
  ctx.fillStyle='#6dfae0'; ctx.font='10px monospace'; ctx.fillText('GOOGLE SHEETS DB',200,56);
  
  try { 
    ctx.drawImage(src,90,72,220,220); 
  } catch(e) { 
    toast('‚ùå QR ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°'); return; 
  }
  
  ctx.fillStyle='#e8e6ff'; ctx.font='bold 13px monospace'; ctx.fillText(currentPayload.name,200,318);
  ctx.fillStyle='#7c6dfa'; ctx.font='11px monospace'; ctx.fillText(currentPayload.cpId,200,336);
  ctx.fillStyle='#6dfae0'; ctx.font='10px monospace';
  ctx.fillText(`${parseFloat(v('fLat')).toFixed(5)}, ${parseFloat(v('fLng')).toFixed(5)}`,200,354);
  ctx.fillStyle='#6b6890'; ctx.font='10px monospace';
  ctx.fillText(`‡∏£‡∏±‡∏®‡∏°‡∏µ ${currentPayload.radius} ‡∏°.  ¬∑  ${currentPayload.timeFrom}‚Äì${currentPayload.timeTo}`,200,372);
  ctx.fillStyle='#0e0d1c'; ctx.fillRect(8,438,384,54);
  ctx.fillStyle='#6dfae0'; ctx.font='9px monospace'; ctx.textAlign='center';
  ctx.fillText('‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢ LINE ¬∑ Smart Checkpoint System',200,460);
  ctx.fillStyle='#3a375a'; ctx.font='9px monospace';
  ctx.fillText(new Date().toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'}),200,478);
  
  const a=document.createElement('a'); 
  a.download=`QR-${currentPayload.cpId}.png`; 
  a.href=c.toDataURL('image/png'); 
  a.click();
  toast('‚¨á ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å QR-' + currentPayload.cpId + '.png ‡πÅ‡∏•‡πâ‡∏ß');
}

function rr(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.arcTo(x+w,y,x+w,y+r,r);ctx.lineTo(x+w,y+h-r);ctx.arcTo(x+w,y+h,x+w-r,y+h,r);ctx.lineTo(x+r,y+h);ctx.arcTo(x,y+h,x,y+h-r,r);ctx.lineTo(x,y+r);ctx.arcTo(x,y,x+r,y,r);}

function doPrint() {
  if (!qrReady) { toast('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏Å‡πà‡∏≠‡∏ô'); return; }
  const d=document.getElementById('qrCanvas').toDataURL('image/png');
  const w=window.open('','_blank');
  if(!w){toast('‚ùå ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï popup ‡∏Å‡πà‡∏≠‡∏ô');return;}
  w.document.write(`<html><head><title>QR ${currentPayload.cpId}</title><style>body{font-family:monospace;text-align:center;padding:32px}.box{display:inline-block;padding:16px;border:2px solid #000;border-radius:10px;margin:10px 0}.info{background:#f5f5f5;padding:10px;border-radius:6px;font-size:11px;text-align:left;max-width:230px;margin:auto}</style></head><body><h2>üõ°Ô∏è ${currentPayload.name}</h2><p>${currentPayload.cpId} ¬∑ ‡∏£‡∏±‡∏®‡∏°‡∏µ ${currentPayload.radius} ‡∏°.</p><div class="box"><img src="${d}" width="200"></div><div class="info"><b>‡∏û‡∏¥‡∏Å‡∏±‡∏î:</b> ${v('fLat')}, ${v('fLng')}<br><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> ${currentPayload.timeFrom}‚Äì${currentPayload.timeTo}</div><script>window.onload=()=>{window.print()}<\/script></body></html>`);
  w.document.close();
}

function copyUrl() {
  if(!currentUrl){toast('‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡∏Å‡πà‡∏≠‡∏ô');return;}
  navigator.clipboard.writeText(currentUrl).then(()=>toast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß')).catch(()=>{
    const t=document.createElement('textarea'); t.value=currentUrl; document.body.appendChild(t); t.select(); document.execCommand('copy'); t.remove(); toast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
  });
}

function setStatus(type,msg){const b=document.getElementById('statusBar');b.className='status-bar '+type;document.getElementById('statusTxt').textContent=msg;}

function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),2800);}

window.addEventListener('DOMContentLoaded',()=>{
  const p=new URLSearchParams(window.location.search);
  if(p.get('id'))    document.getElementById('fId').value=p.get('id');
  if(p.get('name'))  document.getElementById('fName').value=p.get('name');
  if(p.get('lat'))   document.getElementById('fLat').value=p.get('lat');
  if(p.get('lng'))   document.getElementById('fLng').value=p.get('lng');
  if(p.get('radius'))document.getElementById('fRadius').value=p.get('radius');
  
  const liff=localStorage.getItem('sc_liff_url');
  if(liff) document.getElementById('fLiff').value=liff;
  
  if(p.get('id')&&p.get('lat')&&p.get('lng')) generate();
});
</script>
</body>
</html>