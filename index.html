<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
<title>à¹€à¸Šà¹‡à¸„à¸­à¸´à¸™ â€” Smart Checkpoint</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&family=Chakra+Petch:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07060f;--surface:#0e0d1c;--card:#141226;
  --border:#26234a;--border2:#3a375a;
  --accent:#7c6dfa;--accent2:#fa6d9e;--teal:#6dfae0;
  --success:#6dfaa0;--danger:#fa4d6d;--warn:#faad6d;
  --text:#e8e6ff;--mid:#a09cbf;--dim:#6b6890;
  --mono:'Chakra Petch',monospace;--sans:'Sarabun',sans-serif;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;display:flex;flex-direction:column;align-items:center;overflow-x:hidden;}

/* â”€â”€ SCREEN MANAGER â”€â”€ */
.screen{display:none;width:100%;max-width:430px;min-height:100vh;flex-direction:column;padding:20px 16px 40px;}
.screen.active{display:flex;}

/* â”€â”€ HEADER â”€â”€ */
.hdr{display:flex;align-items:center;gap:12px;padding:8px 0 20px;}
.hdr-logo{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.hdr-title{font-family:var(--mono);font-size:12px;font-weight:700;letter-spacing:1px;color:var(--accent);}
.hdr-sub{font-size:11px;color:var(--dim);}

/* â”€â”€ STEP INDICATOR â”€â”€ */
.steps{display:flex;gap:0;margin-bottom:24px;}
.step-item{flex:1;position:relative;}
.step-item::after{content:'';position:absolute;top:12px;left:50%;right:-50%;height:2px;background:var(--border);}
.step-item:last-child::after{display:none;}
.step-item.done::after,.step-item.active::after{background:var(--accent);}
.step-dot{width:24px;height:24px;border-radius:50%;border:2px solid var(--border);background:var(--surface);font-family:var(--mono);font-size:10px;display:flex;align-items:center;justify-content:center;position:relative;z-index:1;margin:0 auto;}
.step-item.done .step-dot{background:var(--accent);border-color:var(--accent);color:#fff;}
.step-item.active .step-dot{border-color:var(--accent);color:var(--accent);}
.step-lbl{font-size:9px;color:var(--dim);text-align:center;margin-top:5px;font-family:var(--mono);letter-spacing:.5px;}
.step-item.active .step-lbl{color:var(--accent);}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:14px;position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2));}
.card-title{font-family:var(--mono);font-size:10px;letter-spacing:1.5px;color:var(--dim);margin-bottom:14px;text-transform:uppercase;}

/* â”€â”€ SCANNER â”€â”€ */
.scan-box{background:var(--surface);border:2px dashed var(--border2);border-radius:12px;aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;margin-bottom:14px;position:relative;overflow:hidden;}
.scan-box.scanning{border-color:var(--accent);border-style:solid;}
#scanVideo{width:100%;height:100%;object-fit:cover;border-radius:10px;display:none;}
.scan-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;}
.scan-frame{width:60%;aspect-ratio:1;border:2px solid rgba(124,109,250,.8);border-radius:8px;position:relative;}
.scan-frame::before,.scan-frame::after,.sf-b::before,.sf-b::after{content:'';position:absolute;width:16px;height:16px;border-color:var(--accent);border-style:solid;}
.scan-frame::before{top:-2px;left:-2px;border-width:3px 0 0 3px;border-radius:2px 0 0 0;}
.scan-frame::after{top:-2px;right:-2px;border-width:3px 3px 0 0;border-radius:0 2px 0 0;}
.sf-b::before{bottom:-2px;left:-2px;border-width:0 0 3px 3px;border-radius:0 0 0 2px;}
.sf-b::after{bottom:-2px;right:-2px;border-width:0 3px 3px 0;border-radius:0 0 2px 0;}
.scan-line{position:absolute;width:80%;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);animation:scanAnim 2s linear infinite;}
@keyframes scanAnim{0%{top:20%}100%{top:80%}}
.scan-icon{font-size:36px;opacity:.4;}
.scan-hint{font-size:12px;color:var(--dim);text-align:center;}

/* â”€â”€ CP INFO â”€â”€ */
.cp-result{background:rgba(124,109,250,.08);border:1px solid rgba(124,109,250,.2);border-radius:10px;padding:14px;margin-bottom:12px;}
.cp-name{font-size:18px;font-weight:700;margin-bottom:6px;}
.cp-meta{display:flex;flex-direction:column;gap:4px;}
.cp-row{display:flex;justify-content:space-between;font-size:12px;}
.cp-key{color:var(--dim);font-family:var(--mono);font-size:10px;letter-spacing:.5px;}
.cp-val{font-family:var(--mono);font-size:11px;color:var(--teal);}
.verified-badge{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;background:rgba(109,250,160,.08);border:1px solid rgba(109,250,160,.2);color:var(--success);font-family:var(--mono);font-size:11px;font-weight:700;margin-top:8px;}

/* â”€â”€ GPS â”€â”€ */
.gps-ring{width:100px;height:100px;border-radius:50%;border:3px solid var(--border);display:flex;align-items:center;justify-content:center;margin:16px auto;position:relative;}
.gps-ring.searching{border-color:var(--accent);animation:spin 2s linear infinite;}
.gps-ring.ok{border-color:var(--success);}
.gps-ring.err{border-color:var(--danger);}
@keyframes spin{to{transform:rotate(360deg)}}
.gps-icon{font-size:28px;}
.gps-dist{text-align:center;font-family:var(--mono);font-size:22px;font-weight:700;}
.gps-status{text-align:center;font-size:13px;color:var(--dim);margin-top:4px;}
.dist-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-top:12px;}
.dist-fill{height:100%;background:var(--success);border-radius:3px;transition:width .5s ease;}

/* â”€â”€ CAMERA â”€â”€ */
.cam-wrap{position:relative;background:#000;border-radius:12px;overflow:hidden;aspect-ratio:4/3;margin-bottom:12px;}
#camVideo{width:100%;height:100%;object-fit:cover;}
#snapCanvas{display:none;}
.cam-overlay{position:absolute;inset:0;pointer-events:none;}
.watermark{position:absolute;bottom:10px;left:10px;right:10px;background:rgba(0,0,0,.6);padding:6px 10px;border-radius:6px;font-family:var(--mono);font-size:9px;color:rgba(255,255,255,.85);line-height:1.6;}
.shutter{width:64px;height:64px;border-radius:50%;background:#fff;border:4px solid rgba(255,255,255,.4);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:24px;transition:.15s;margin:0 auto;}
.shutter:hover{transform:scale(1.06);}
.shutter:active{transform:scale(.95);}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{width:100%;padding:14px;border-radius:10px;border:none;font-family:var(--sans);font-size:15px;font-weight:700;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:10px;}
.btn.primary{background:linear-gradient(135deg,var(--accent),#5a4de0);color:#fff;box-shadow:0 4px 18px rgba(124,109,250,.3);}
.btn.primary:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(124,109,250,.4);}
.btn.primary:active{transform:translateY(0);}
.btn.sec{background:var(--surface);border:1px solid var(--border2);color:var(--mid);}
.btn.sec:hover{border-color:var(--accent);color:var(--accent);}
.btn.success{background:linear-gradient(135deg,var(--success),#3ab070);color:#111;}
.btn.danger{background:var(--surface);border:1px solid var(--danger);color:var(--danger);}
.btn:disabled{opacity:.4;pointer-events:none;}

/* â”€â”€ RESULT â”€â”€ */
.result-icon{font-size:64px;text-align:center;margin:16px 0;}
.result-msg{font-size:20px;font-weight:700;text-align:center;margin-bottom:8px;}
.result-sub{font-size:14px;color:var(--mid);text-align:center;}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--card);border:1px solid var(--border2);padding:10px 20px;border-radius:10px;font-size:13px;opacity:0;transition:.3s;z-index:999;white-space:nowrap;box-shadow:0 6px 24px rgba(0,0,0,.5);}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
#toast.err{border-color:var(--danger);}
</style>
</head>
<body>

<!-- SCREEN 1: SCAN -->
<div class="screen active" id="s1">
  <div class="hdr">
    <div class="hdr-logo">ğŸ›¡ï¸</div>
    <div><div class="hdr-title">SMART CHECKPOINT</div><div class="hdr-sub" id="officerName">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div></div>
  </div>
  <div class="steps">
    <div class="step-item active"><div class="step-dot">1</div><div class="step-lbl">à¸ªà¹à¸à¸™ QR</div></div>
    <div class="step-item"><div class="step-dot">2</div><div class="step-lbl">à¸•à¸£à¸§à¸ˆ GPS</div></div>
    <div class="step-item"><div class="step-dot">3</div><div class="step-lbl">à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸</div></div>
    <div class="step-item"><div class="step-dot">4</div><div class="step-lbl">à¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div></div>
  </div>
  <div class="card">
    <div class="card-title">à¸ªà¹à¸à¸™ QR Code à¸ˆà¸¸à¸”à¸•à¸£à¸§à¸ˆ</div>
    <div class="scan-box" id="scanBox">
      <video id="scanVideo" autoplay playsinline></video>
      <div class="scan-overlay" id="scanOverlay">
        <div class="scan-frame"><div class="sf-b"></div><div class="scan-line"></div></div>
      </div>
      <span class="scan-icon" id="scanIcon">ğŸ”²</span>
      <span class="scan-hint" id="scanHint">à¸à¸”à¸›à¸¸à¹ˆà¸¡à¸”à¹‰à¸²à¸™à¸¥à¹ˆà¸²à¸‡à¹€à¸à¸·à¹ˆà¸­à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡</span>
    </div>
    <div id="cpResult" style="display:none;"></div>
    <button class="btn primary" id="btnStartScan" onclick="startScan()">ğŸ“· à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡à¸ªà¹à¸à¸™ QR</button>
    <button class="btn sec" id="btnNextToGps" onclick="goToGps()" style="display:none;">ğŸ” à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ GPS â†’</button>
    <button class="btn sec" onclick="demoScan()">âš¡ Demo (à¸—à¸”à¸ªà¸­à¸š)</button>
  </div>
</div>

<!-- SCREEN 2: GPS -->
<div class="screen" id="s2">
  <div class="hdr">
    <div class="hdr-logo">ğŸ“</div>
    <div><div class="hdr-title">à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸•à¸³à¹à¸«à¸™à¹ˆà¸‡</div><div class="hdr-sub" id="s2Sub">à¸à¸³à¸¥à¸±à¸‡à¸£à¸°à¸šà¸¸à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡...</div></div>
  </div>
  <div class="steps">
    <div class="step-item done"><div class="step-dot">âœ“</div><div class="step-lbl">à¸ªà¹à¸à¸™ QR</div></div>
    <div class="step-item active"><div class="step-dot">2</div><div class="step-lbl">à¸•à¸£à¸§à¸ˆ GPS</div></div>
    <div class="step-item"><div class="step-dot">3</div><div class="step-lbl">à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸</div></div>
    <div class="step-item"><div class="step-dot">4</div><div class="step-lbl">à¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div></div>
  </div>
  <div class="card">
    <div class="card-title" id="cpNameOnGps">â€”</div>
    <div class="gps-ring searching" id="gpsRing"><span class="gps-icon">ğŸ“¡</span></div>
    <div class="gps-dist" id="gpsDist">à¸à¸³à¸¥à¸±à¸‡à¸£à¸°à¸šà¸¸...</div>
    <div class="gps-status" id="gpsStatus">à¸à¸³à¸¥à¸±à¸‡à¸£à¸±à¸šà¸ªà¸±à¸à¸à¸²à¸“ GPS</div>
    <div class="dist-bar"><div class="dist-fill" id="distFill" style="width:0%;background:var(--warn);"></div></div>
    <div style="display:flex;justify-content:space-between;font-family:var(--mono);font-size:9px;color:var(--dim);margin-top:6px;">
      <span>0 à¸¡.</span><span id="radiusLabel">50 à¸¡.</span>
    </div>
  </div>
  <button class="btn primary" id="btnToCamera" onclick="goToCamera()" disabled>ğŸ“· à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸ â†’</button>
  <button class="btn sec" onclick="goBack('s1')">â† à¸ªà¹à¸à¸™à¹ƒà¸«à¸¡à¹ˆ</button>
</div>

<!-- SCREEN 3: CAMERA -->
<div class="screen" id="s3">
  <div class="hdr">
    <div class="hdr-logo">ğŸ“¸</div>
    <div><div class="hdr-title">à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸à¸¢à¸·à¸™à¸¢à¸±à¸™</div><div class="hdr-sub" id="s3Sub">â€”</div></div>
  </div>
  <div class="steps">
    <div class="step-item done"><div class="step-dot">âœ“</div><div class="step-lbl">à¸ªà¹à¸à¸™ QR</div></div>
    <div class="step-item done"><div class="step-dot">âœ“</div><div class="step-lbl">à¸•à¸£à¸§à¸ˆ GPS</div></div>
    <div class="step-item active"><div class="step-dot">3</div><div class="step-lbl">à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸</div></div>
    <div class="step-item"><div class="step-dot">4</div><div class="step-lbl">à¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div></div>
  </div>
  <div class="cam-wrap">
    <video id="camVideo" autoplay playsinline muted></video>
    <canvas id="snapCanvas"></canvas>
    <div class="cam-overlay"><div class="watermark" id="wm"></div></div>
  </div>
  <div style="display:flex;gap:10px;margin-bottom:10px;">
    <button class="btn sec" id="btnRetake" onclick="retakePhoto()" style="display:none;">ğŸ—‘ï¸ à¸–à¹ˆà¸²à¸¢à¹ƒà¸«à¸¡à¹ˆ</button>
    <button class="shutter" id="shutterBtn" onclick="takePhoto()">ğŸ“·</button>
  </div>
  <button class="btn success" id="btnSubmit" onclick="submitCheckin()" disabled>âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™ â†’ à¸šà¸±à¸™à¸—à¸¶à¸ Google Sheets</button>
  <button class="btn sec" onclick="goBack('s2')">â† à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š</button>
</div>

<!-- SCREEN 4: SUCCESS -->
<div class="screen" id="s4">
  <div class="hdr">
    <div class="hdr-logo">âœ…</div>
    <div><div class="hdr-title">à¹€à¸Šà¹‡à¸„à¸­à¸´à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ</div><div class="hdr-sub" id="s4Time">â€”</div></div>
  </div>
  <div class="card">
    <div class="result-icon">ğŸ‰</div>
    <div class="result-msg">à¹€à¸Šà¹‡à¸„à¸­à¸´à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§!</div>
    <div class="result-sub" id="s4Detail">â€”</div>
    <div style="height:12px;"></div>
    <div class="cp-result">
      <div class="cp-meta" id="s4Info"></div>
    </div>
  </div>
  <button class="btn primary" onclick="resetAll()">ğŸ”„ à¹€à¸Šà¹‡à¸„à¸­à¸´à¸™à¸ˆà¸¸à¸”à¸•à¹ˆà¸­à¹„à¸›</button>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” à¸­à¹ˆà¸²à¸™à¸ˆà¸²à¸ localStorage à¸«à¸£à¸·à¸­ URL params
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function parseUrlParams() {
  const p = new URLSearchParams(window.location.search);
  if (p.get('api'))    { localStorage.setItem('sc_api_url', p.get('api')); }
  if (p.get('secret')) { localStorage.setItem('sc_secret',  p.get('secret')); }
  if (p.get('liff'))   { localStorage.setItem('sc_liff_id', p.get('liff')); }
})();

const API_URL  = localStorage.getItem('sc_api_url') || '';
const SECRET   = localStorage.getItem('sc_secret')  || '';
const LIFF_ID  = localStorage.getItem('sc_liff_id') || '';

let officerId   = 'demo-officer';
let officerNameStr = 'à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ';
let cpData      = null;    // à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸¸à¸”à¸•à¸£à¸§à¸ˆà¸ˆà¸²à¸ QR
let myLat       = null;
let myLng       = null;
let myDist      = null;
let photoDataUrl = null;
let scanStream  = null;
let camStream   = null;
let gpsWatch    = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callApi(action, params = {}) {
  if (!API_URL) return { ok: false, _demo: true, error: 'No API URL (Demo mode)' };
  const p = new URLSearchParams({ action, ...params });
  const r = await fetch(API_URL + '?' + p.toString());
  return r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” LIFF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initLiff() {
  if (!LIFF_ID) {
    document.getElementById('officerName').textContent = 'Demo Mode';
    if (!API_URL) showToast('âš ï¸ Demo Mode â€” à¹„à¸¡à¹ˆà¸¡à¸µ API URL', 'err');
    return;
  }
  try {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isLoggedIn()) { liff.login(); return; }
    const profile = await liff.getProfile();
    officerId      = profile.userId;
    officerNameStr = profile.displayName;
    document.getElementById('officerName').textContent = officerNameStr;
  } catch(e) {
    document.getElementById('officerName').textContent = 'à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ LINE';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 1: SCAN QR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startScan() {
  const box = document.getElementById('scanBox');
  const video = document.getElementById('scanVideo');
  const icon = document.getElementById('scanIcon');
  const hint = document.getElementById('scanHint');

  try {
    scanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = scanStream;
    video.style.display = 'block';
    icon.style.display  = 'none';
    hint.style.display  = 'none';
    box.classList.add('scanning');
    document.getElementById('btnStartScan').disabled = true;

    const tick = setInterval(async () => {
      if (!scanStream) { clearInterval(tick); return; }
      if ('BarcodeDetector' in window) {
        const bd = new BarcodeDetector({ formats: ['qr_code'] });
        try {
          const codes = await bd.detect(video);
          if (codes.length > 0) { clearInterval(tick); onQrDetected(codes[0].rawValue); }
        } catch(e) {}
      }
    }, 500);

    showToast('à¸à¸³à¸¥à¸±à¸‡à¸ªà¹à¸à¸™ QR...');
  } catch(e) {
    showToast('âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡à¹„à¸”à¹‰: ' + e.message, 'err');
    document.getElementById('btnStartScan').disabled = false;
  }
}

function onQrDetected(raw) {
  stopScanStream();
  try {
    let payload;
    if (raw.startsWith('data:checkpoint,')) {
      payload = JSON.parse(atob(raw.replace('data:checkpoint,', '')));
    } else {
      const url = new URL(raw);
      const cp = url.searchParams.get('cp');
      if (!cp) throw new Error('à¹„à¸¡à¹ˆà¸à¸š QR à¸—à¸µà¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
      payload = JSON.parse(atob(cp));
    }

    // à¸•à¸£à¸§à¸ˆà¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸ (5 à¸™à¸²à¸—à¸µ)
    const expire = (payload.expireMinutes || 5) * 60 * 1000;
    if (Date.now() - payload.ts > expire) {
      showToast('âŒ QR à¸«à¸¡à¸”à¸­à¸²à¸¢à¸¸à¹à¸¥à¹‰à¸§ â€” à¸‚à¸­à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸ Admin', 'err');
      document.getElementById('btnStartScan').disabled = false;
      return;
    }

    cpData = payload;
    renderCpResult(payload);
    showToast('âœ… à¸ªà¹à¸à¸™ ' + payload.name + ' à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!');
  } catch(e) {
    showToast('âŒ QR à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡: ' + e.message, 'err');
    document.getElementById('btnStartScan').disabled = false;
  }
}

function renderCpResult(p) {
  const el = document.getElementById('cpResult');
  el.style.display = 'block';
  el.innerHTML = `<div class="cp-result">
    <div class="cp-name">ğŸ“ ${p.name}</div>
    <div class="cp-meta">
      <div class="cp-row"><span class="cp-key">CP ID</span><span class="cp-val">${p.cpId}</span></div>
      <div class="cp-row"><span class="cp-key">à¸à¸´à¸à¸±à¸”</span><span class="cp-val">${Number(p.lat).toFixed(5)}, ${Number(p.lng).toFixed(5)}</span></div>
      <div class="cp-row"><span class="cp-key">à¸£à¸±à¸¨à¸¡à¸µ</span><span class="cp-val">${p.radius} à¸¡.</span></div>
      <div class="cp-row"><span class="cp-key">à¹€à¸§à¸¥à¸²</span><span class="cp-val">${p.timeFrom}â€“${p.timeTo}</span></div>
    </div>
    <div class="verified-badge">âœ… QR à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¹à¸¥à¹‰à¸§</div>
  </div>`;
  document.getElementById('btnStartScan').style.display = 'none';
  document.getElementById('btnNextToGps').style.display = 'flex';
}

function stopScanStream() {
  if (scanStream) { scanStream.getTracks().forEach(t => t.stop()); scanStream = null; }
  const video = document.getElementById('scanVideo');
  video.style.display = 'none';
  document.getElementById('scanIcon').style.display = 'block';
  document.getElementById('scanHint').style.display = 'block';
  document.getElementById('scanBox').classList.remove('scanning');
}

function demoScan() {
  cpData = { cpId:'CP-DEMO', name:'à¸ˆà¸¸à¸”à¸•à¸£à¸§à¸ˆ Demo', lat:13.756, lng:100.501, radius:100, timeFrom:'00:00', timeTo:'23:59', ts:Date.now() };
  renderCpResult(cpData);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 2: GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goToGps() {
  if (!cpData) { showToast('âŒ à¸à¸£à¸¸à¸“à¸²à¸ªà¹à¸à¸™ QR à¸à¹ˆà¸­à¸™', 'err'); return; }
  showScreen('s2');
  document.getElementById('cpNameOnGps').textContent = 'ğŸ“ ' + cpData.name;
  document.getElementById('radiusLabel').textContent = cpData.radius + ' à¸¡.';
  startGps();
}

function startGps() {
  if (!navigator.geolocation) { showToast('âŒ GPS à¹„à¸¡à¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š', 'err'); return; }
  gpsWatch = navigator.geolocation.watchPosition(pos => {
    myLat = pos.coords.latitude;
    myLng = pos.coords.longitude;
    myDist = haversine(myLat, myLng, Number(cpData.lat), Number(cpData.lng));
    updateGpsUI(myDist);
  }, err => {
    showToast('âŒ GPS: ' + err.message, 'err');
  }, { enableHighAccuracy: true, maximumAge: 5000 });
}

function updateGpsUI(dist) {
  const ring   = document.getElementById('gpsRing');
  const distEl = document.getElementById('gpsDist');
  const status = document.getElementById('gpsStatus');
  const fill   = document.getElementById('distFill');
  const btn    = document.getElementById('btnToCamera');
  const radius = Number(cpData.radius);

  const pct = Math.min(100, (dist / radius) * 100);
  const inside = dist <= radius;

  distEl.textContent = Math.round(dist) + ' à¸¡.';
  fill.style.width   = pct + '%';
  fill.style.background = inside ? 'var(--success)' : 'var(--warn)';

  if (inside) {
    ring.className   = 'gps-ring ok';
    status.textContent = 'âœ… à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸£à¸°à¸¢à¸°à¹à¸¥à¹‰à¸§! (' + Math.round(dist) + '/' + radius + ' à¸¡.)';
    status.style.color = 'var(--success)';
    btn.disabled = false;
  } else {
    ring.className   = 'gps-ring searching';
    status.textContent = 'â³ à¸­à¸¢à¸¹à¹ˆà¸«à¹ˆà¸²à¸‡ ' + Math.round(dist) + ' à¸¡. (à¸•à¹‰à¸­à¸‡à¸­à¸¢à¸¹à¹ˆà¸ à¸²à¸¢à¹ƒà¸™ ' + radius + ' à¸¡.)';
    status.style.color = 'var(--warn)';
    btn.disabled = true;
  }
  document.getElementById('s2Sub').textContent = 'à¸«à¹ˆà¸²à¸‡ ' + Math.round(dist) + ' à¸¡.';
}

function stopGps() {
  if (gpsWatch !== null) { navigator.geolocation.clearWatch(gpsWatch); gpsWatch = null; }
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000, toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN 3: CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function goToCamera() {
  stopGps();
  showScreen('s3');
  document.getElementById('s3Sub').textContent = cpData.name + ' Â· ' + Math.round(myDist||0) + ' à¸¡.';
  updateWatermark();
  await startCamera();
}

async function startCamera() {
  try {
    camStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width:{ ideal:1280 }, height:{ ideal:960 } } });
    document.getElementById('camVideo').srcObject = camStream;
  } catch(e) { showToast('âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡: ' + e.message, 'err'); }
}

function updateWatermark() {
  const wm = document.getElementById('wm');
  const now = new Date();
  wm.innerHTML = `ğŸ›¡ï¸ ${cpData?.name||'â€”'}<br>ğŸ“ ${myLat?myLat.toFixed(5):'â€”'}, ${myLng?myLng.toFixed(5):'â€”'}  |  â†” ${Math.round(myDist||0)} à¸¡.<br>ğŸ• ${now.toLocaleString('th-TH')}  |  ${officerNameStr}`;
}

function takePhoto() {
  const video = document.getElementById('camVideo');
  const canvas = document.getElementById('snapCanvas');
  canvas.width  = video.videoWidth  || 640;
  canvas.height = video.videoHeight || 480;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);

  // watermark overlay
  const now = new Date();
  ctx.fillStyle = 'rgba(0,0,0,0.55)';
  ctx.fillRect(0, canvas.height - 52, canvas.width, 52);
  ctx.fillStyle = '#fff'; ctx.font = `${Math.round(canvas.width/40)}px monospace`;
  const fs = Math.round(canvas.width/40);
  ctx.fillText(`ğŸ›¡ï¸ ${cpData?.name||''}`, 10, canvas.height - 32);
  ctx.fillText(`${now.toLocaleString('th-TH')}  |  ${Math.round(myDist||0)} à¸¡.  |  ${officerNameStr}`, 10, canvas.height - 10);

  photoDataUrl = canvas.toDataURL('image/jpeg', 0.85);

  // à¹à¸ªà¸”à¸‡à¸£à¸¹à¸›à¸–à¹ˆà¸²à¸¢
  const camWrap = document.querySelector('.cam-wrap');
  const showImg = document.createElement('img');
  showImg.src = photoDataUrl;
  showImg.style.cssText = 'width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:12px;';
  showImg.id = 'previewImg';
  camWrap.appendChild(showImg);

  document.getElementById('shutterBtn').style.display = 'none';
  document.getElementById('btnRetake').style.display  = 'flex';
  document.getElementById('btnSubmit').disabled = false;
  showToast('ğŸ“¸ à¸–à¹ˆà¸²à¸¢à¸ à¸²à¸à¹à¸¥à¹‰à¸§ â€” à¸à¸” âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™');
}

function retakePhoto() {
  photoDataUrl = null;
  const prev = document.getElementById('previewImg');
  if (prev) prev.remove();
  document.getElementById('shutterBtn').style.display = 'flex';
  document.getElementById('btnRetake').style.display  = 'none';
  document.getElementById('btnSubmit').disabled = true;
  updateWatermark();
}

function stopCamera() {
  if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT CHECK-IN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitCheckin() {
  if (!cpData || !photoDataUrl) { showToast('âŒ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸¡à¹ˆà¸„à¸£à¸š','err'); return; }
  document.getElementById('btnSubmit').disabled = true;
  document.getElementById('btnSubmit').textContent = 'â³ à¸à¸³à¸¥à¸±à¸‡à¸šà¸±à¸™à¸—à¸¶à¸...';

  try {
    const params = {
      checkpointId: cpData.cpId,
      officerId,
      officerName: officerNameStr,
      lat: myLat || cpData.lat,
      lng: myLng || cpData.lng,
      photoUrl: photoDataUrl.substring(0, 200) + '...',  // truncate for URL limit
      note: ''
    };

    const res = await callApi('saveCheckin', params);

    if (res._demo) {
      // demo mode
      showScreen('s4');
      renderSuccess({ distance: Math.round(myDist||0), status:'demo', id:'DEMO-'+Date.now() });
      return;
    }

    if (!res.ok) throw new Error(res.error || 'à¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ');

    stopCamera();
    showScreen('s4');
    renderSuccess(res);
  } catch(e) {
    document.getElementById('btnSubmit').disabled = false;
    document.getElementById('btnSubmit').textContent = 'âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™ â†’ à¸šà¸±à¸™à¸—à¸¶à¸ Google Sheets';
    showToast('âŒ ' + e.message, 'err');
  }
}

function renderSuccess(res) {
  const now = new Date();
  document.getElementById('s4Time').textContent = now.toLocaleString('th-TH');
  document.getElementById('s4Detail').textContent =
    'à¸šà¸±à¸™à¸—à¸¶à¸à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ Â· à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡ ' + res.distance + ' à¸¡. Â· ' + (res.status === 'verified' ? 'âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™à¹à¸¥à¹‰à¸§' : 'âš ï¸ à¸™à¸­à¸à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ');
  document.getElementById('s4Info').innerHTML = `
    <div class="cp-row"><span class="cp-key">à¸ˆà¸¸à¸”à¸•à¸£à¸§à¸ˆ</span><span class="cp-val">${cpData?.name||'â€”'}</span></div>
    <div class="cp-row"><span class="cp-key">à¹€à¸ˆà¹‰à¸²à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ</span><span class="cp-val">${officerNameStr}</span></div>
    <div class="cp-row"><span class="cp-key">à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡</span><span class="cp-val">${res.distance} à¸¡.</span></div>
    <div class="cp-row"><span class="cp-key">à¸£à¸«à¸±à¸ª</span><span class="cp-val">${res.id||'â€”'}</span></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function goBack(screen) {
  stopGps();
  if (screen === 's2') stopCamera();
  showScreen(screen);
}

function resetAll() {
  stopGps(); stopScanStream(); stopCamera();
  cpData = myLat = myLng = myDist = photoDataUrl = null;
  document.getElementById('cpResult').style.display = 'none';
  document.getElementById('btnStartScan').style.display = 'flex';
  document.getElementById('btnStartScan').disabled = false;
  document.getElementById('btnNextToGps').style.display = 'none';
  document.getElementById('btnSubmit').disabled = true;
  document.getElementById('btnSubmit').textContent = 'âœ… à¸¢à¸·à¸™à¸¢à¸±à¸™ â†’ à¸šà¸±à¸™à¸—à¸¶à¸ Google Sheets';
  const prev = document.getElementById('previewImg');
  if (prev) prev.remove();
  document.getElementById('shutterBtn').style.display = 'flex';
  document.getElementById('btnRetake').style.display = 'none';
  showScreen('s1');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'show ' + type;
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.className = ''; }, 2800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  initLiff();
  // à¸­à¸±à¸›à¹€à¸”à¸• watermark à¸—à¸¸à¸ 10 à¸§à¸´
  setInterval(updateWatermark, 10000);
});
</script>
</body>
</html>
